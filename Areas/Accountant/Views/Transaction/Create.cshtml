@using Cascade.Areas.Accountant.Controllers
@using Cascade.Fx9Kl2
@using Cascade.Services
@model SimpleTransactionCreateViewModel
@{
    ViewData["Title"] = "New Transaction - Simplified";
}

<div class="max-w-5xl mx-auto py-2">
    <!-- Modern Header with Navigation -->
    <div class="mb-6">
        <div class="flex items-center justify-between bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
            <div class="flex items-center space-x-4">
                <a href="javascript:history.back()"
                    class="w-10 h-10 bg-slate-100 hover:bg-slate-200 rounded-lg flex items-center justify-center transition-colors">
                    <i class="fa-solid fa-arrow-left text-slate-600"></i>
                </a>
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-r from-cascadeBlue to-aquaMist rounded-xl flex items-center justify-center">
                        @if (ViewBag.IsCorrection == true)
                        {
                            <i class="fas fa-redo text-white text-2xl"></i>
                        }
                        else
                        {
                            <i class="fas fa-plus text-white text-2xl"></i>
                        }
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">
                            @if (ViewBag.IsCorrection == true)
                            {
                                @:Correcting Transaction Entry
                            }
                            else
                            {
                                @:New Transaction - Simple Entry
                            }
                        </h1>
                        <p class="text-slate-600">Just select one account and let the system handle the rest</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <a href="@Url.Action("Index", "Dashboard", new { area = "Accountant" })" 
                   class="inline-flex items-center px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
                    <i class="fas fa-tachometer-alt mr-2"></i>
                    Dashboard
                </a>
                <a href="@Url.Action("GeneralJournal", "Reports", new { area = "" })" 
                   class="inline-flex items-center px-4 py-2 bg-cascadeBlue hover:bg-cascadeBlue/90 text-white rounded-lg transition-colors">
                    <i class="fas fa-book mr-2"></i>
                    Journal
                </a>
            </div>
        </div>
    </div>

    @if (ViewBag.IsCorrection == true)
    {
        <div class="mb-6 p-4 bg-orange-50 border border-orange-200 rounded-lg">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-orange-600 mr-3"></i>
                <div>
                    <h3 class="text-orange-800 font-bold">Creating Correcting Entry</h3>
                    <p class="text-orange-700 text-sm">
                        You're creating a correcting entry that will reverse the original Transaction and create a new one.
                    </p>
                </div>
            </div>
        </div>
    }

    <!-- Success/Error Messages -->
    @if (TempData["Success"] != null)
    {
        <div class="bg-green-50 border border-green-200 rounded-md p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-check-circle text-green-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-green-800">@TempData["Success"]</p>
                </div>
            </div>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="bg-red-50 border border-red-200 rounded-md p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-circle text-red-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-red-800">@TempData["Error"]</p>
                </div>
            </div>
        </div>
    }

    
    <form asp-action="Create" method="post" id="transactionForm">
        <!-- Hidden fields for correction state -->
        @if (ViewBag.IsCorrection == true)
        {
            <input type="hidden" name="IsCorrection" value="true" />
            <input type="hidden" name="CorrectingTransactionId" value="@Model.CorrectingTransactionId" />
        }
        
        @if (ViewBag.IsCorrection == true && ViewBag.OriginalTransaction != null)
        {
            var originalTransaction = ViewBag.OriginalTransaction as Pz7Vm5Protocol;
            <!-- Original Transaction Display -->
            <div class="mb-6 p-6 bg-blue-50 border border-blue-200 rounded-xl">
                <h3 class="text-blue-800 font-bold mb-4">
                    <i class="fas fa-file-invoice mr-2"></i>Original Transaction Being Corrected
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <span class="text-blue-700 font-medium">Date:</span>
                        <span class="text-blue-900">@originalTransaction.TransactionDate.ToString("MMM dd, yyyy")</span>
                    </div>
                    <div>
                        <span class="text-blue-700 font-medium">Reference:</span>
                        <span class="text-blue-900">@(string.IsNullOrEmpty(originalTransaction.ReferenceNo) ? "N/A" : originalTransaction.ReferenceNo)</span>
                    </div>
                    <div>
                        <span class="text-blue-700 font-medium">Transaction ID:</span>
                        <span class="text-blue-900">#@originalTransaction.TransactionId</span>
                    </div>
                </div>
                <div class="mb-4">
                    <span class="text-blue-700 font-medium">Description:</span>
                    <span class="text-blue-900">@originalTransaction.Description</span>
                </div>
                
                <!-- Display Original Transaction Lines -->
                <div class="space-y-2">
                    <h4 class="text-blue-800 font-medium">
                        <i class="fas fa-list mr-2"></i>Original Entries
                    </h4>
                    @foreach (var line in originalTransaction.ProcessHandlers)
                    {
                        <div class="flex justify-between items-center p-3 bg-blue-100 rounded-lg">
                            <span class="text-blue-900 font-medium">@line.Qw8Rt5Entity.AccountName</span>
                            <div class="flex space-x-4">
                                @if (line.Debit > 0)
                                {
                                    <span class="text-green-700 font-semibold">Debit: R @line.Debit.ToString("N2")</span>
                                }
                                @if (line.Credit > 0)
                                {
                                    <span class="text-red-700 font-semibold">Credit: R @line.Credit.ToString("N2")</span>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Transaction Details -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
                    <h2 class="text-xl font-bold text-slate-900 mb-8">Transaction Details</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Left Sub-Column -->
                        <div class="space-y-6">
                            <!-- Transaction Date -->
                            <div>
                                <label asp-for="TransactionDate" class="block text-slate-700 font-medium mb-3">
                                    <i class="fas fa-calendar mr-2 text-cascadeBlue"></i>Transaction Date
                                </label>
                                <input asp-for="TransactionDate" type="date" 
                                       class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg text-slate-900 focus:outline-none focus:ring-2 focus:ring-cascadeBlue focus:border-transparent" />
                                <span asp-validation-for="TransactionDate" class="text-red-600 text-sm mt-1 block"></span>
                            </div>

                            <!-- Description -->
                            <div>
                                <label asp-for="Description" class="block text-slate-700 font-medium mb-3">
                                    <i class="fas fa-edit mr-2 text-cascadeBlue"></i>Description
                                    <button type="button" id="generateDescription" class="ml-2 text-xs bg-aquaMist hover:bg-aquaMist/80 text-slate-700 px-2 py-1 rounded transition-colors">
                                        <i class="fas fa-magic mr-1"></i>Auto Generate
                                    </button>
                                </label>
                                <input asp-for="Description" id="descriptionInput"
                                       class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-cascadeBlue focus:border-transparent" 
                                       placeholder="What is this Transaction for?" />
                                <div id="descriptionSuggestions" class="mt-2 space-y-1 hidden">
                                    <p class="text-xs text-slate-600 mb-2">Suggested descriptions:</p>
                                    <div id="suggestionsList" class="space-y-1"></div>
                                </div>
                                <span asp-validation-for="Description" class="text-red-600 text-sm mt-1 block"></span>
                            </div>

                            <!-- Reference Number -->
                            <div>
                                <label asp-for="ReferenceNo" class="block text-slate-700 font-medium mb-3">
                                    <i class="fas fa-hashtag mr-2 text-cascadeBlue"></i>Reference Number <span class="text-slate-500 text-sm">(Optional)</span>
                                    <button type="button" id="generateReference" class="ml-2 text-xs bg-aquaMist hover:bg-aquaMist/80 text-slate-700 px-2 py-1 rounded transition-colors">
                                        <i class="fas fa-magic mr-1"></i>Auto Generate
                                    </button>
                                </label>
                                <input asp-for="ReferenceNo" id="referenceInput"
                                       class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-cascadeBlue focus:border-transparent" 
                                       placeholder="Invoice number, receipt number, etc." />
                                <div id="referenceSuggestions" class="mt-2 space-y-1 hidden">
                                    <p class="text-xs text-slate-600 mb-2">Suggested reference formats:</p>
                                    <div id="referenceList" class="space-y-1"></div>
                                </div>
                                <span asp-validation-for="ReferenceNo" class="text-red-600 text-sm mt-1 block"></span>
                            </div>
                        </div>

                        <!-- Right Sub-Column -->
                        <div class="space-y-6">
                            <!-- Transaction Direction -->
                            <div>
                                <label asp-for="Direction" class="block text-slate-700 font-medium mb-3">
                                    <i class="fas fa-exchange-alt mr-2 text-cascadeBlue"></i>Transaction Type
                                </label>
                                <div class="space-y-3">
                                    <label class="flex items-center p-4 bg-green-50 border-2 border-green-200 rounded-lg cursor-pointer hover:bg-green-100 transition-colors">
                                        <input type="radio" asp-for="Direction" value="@TransactionDirection.MoneyOut" class="sr-only" />
                                        <div class="w-5 h-5 bg-white border-2 border-green-400 rounded-full mr-3 flex items-center justify-center">
                                            <div class="w-2 h-2 bg-green-500 rounded-full hidden radio-dot"></div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-semibold text-green-800">ðŸ’° Money Out</div>
                                            <div class="text-sm text-green-600">Expenses, purchases, payments</div>
                                        </div>
                                    </label>
                                    
                                    <label class="flex items-center p-4 bg-blue-50 border-2 border-blue-200 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors">
                                        <input type="radio" asp-for="Direction" value="@TransactionDirection.MoneyIn" class="sr-only" />
                                        <div class="w-5 h-5 bg-white border-2 border-blue-400 rounded-full mr-3 flex items-center justify-center">
                                            <div class="w-2 h-2 bg-blue-500 rounded-full hidden radio-dot"></div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-semibold text-blue-800">ðŸ“ˆ Money In</div>
                                            <div class="text-sm text-blue-600">Income, sales, receipts</div>
                                        </div>
                                    </label>
                                    
                                    <label class="flex items-center p-4 bg-purple-50 border-2 border-purple-200 rounded-lg cursor-pointer hover:bg-purple-100 transition-colors">
                                        <input type="radio" asp-for="Direction" value="@TransactionDirection.Transfer" class="sr-only" />
                                        <div class="w-5 h-5 bg-white border-2 border-purple-400 rounded-full mr-3 flex items-center justify-center">
                                            <div class="w-2 h-2 bg-purple-500 rounded-full hidden radio-dot"></div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-semibold text-purple-800">ðŸ”„ Transfer</div>
                                            <div class="text-sm text-purple-600">Moving money between accounts</div>
                                        </div>
                                    </label>
                                </div>
                                <span asp-validation-for="Direction" class="text-red-600 text-sm mt-1 block"></span>
                            </div>

                            <!-- Account Selection -->
                            <div>
                                <label asp-for="SelectedAccountId" class="block text-slate-700 font-medium mb-3">
                                    <i class="fas fa-search mr-2 text-cascadeBlue"></i>Select Account
                                </label>
                                <div class="relative">
                                    <input type="text" id="accountSearch" 
                                           class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-cascadeBlue focus:border-transparent" 
                                           placeholder="Search for Account..." autocomplete="off" />
                                    <div id="accountDropdown" class="absolute z-10 w-full bg-white border border-slate-300 rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto"></div>
                                </div>
                                <input type="hidden" asp-for="SelectedAccountId" id="selectedAccountId" />
                                <div id="selectedAccount" class="mt-2 hidden p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <span class="text-blue-800 font-medium"></span>
                                    <button type="button" id="clearAccount" class="ml-2 text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="SelectedAccountId" class="text-red-600 text-sm mt-1 block"></span>
                            </div>

                            <!-- Amount -->
                            <div>
                                <label asp-for="Amount" class="block text-slate-700 font-medium mb-3">
                                    <i class="mr-2 text-cascadeBlue">R</i>Amount
                                </label>
                                <input asp-for="Amount" type="number" step="0.01" min="0.01" 
                                       class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-cascadeBlue focus:border-transparent" 
                                       placeholder="0.00" />
                                <span asp-validation-for="Amount" class="text-red-600 text-sm mt-1 block"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Smart Preview -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 sticky top-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">
                        <i class="fas fa-magic mr-2 text-cascadeBlue"></i>Smart Preview
                    </h3>
                    
                    <div id="transactionPreview" class="space-y-4">
                        <!-- Default state -->
                        <div id="previewEmpty" class="text-center py-8">
                            <i class="fas fa-lightbulb text-slate-400 text-3xl mb-3"></i>
                            <p class="text-slate-600">Fill in the details to see the automatic account mapping</p>
                        </div>
                        
                        <!-- Preview content (hidden by default) -->
                        <div id="previewContent" class="hidden space-y-4">
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-4">
                                <div class="text-sm text-blue-600 font-medium mb-2">Selected Account</div>
                                <div id="previewSelectedAccount" class="font-semibold text-blue-900"></div>
                            </div>
                            
                            <div class="text-center">
                                <i id="previewArrow" class="fas fa-arrow-down text-slate-400 text-xl"></i>
                            </div>
                            
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4">
                                <div class="text-sm text-green-600 font-medium mb-2">System Auto-Selects</div>
                                <div id="previewContraAccount" class="font-semibold text-green-900"></div>
                            </div>
                            
                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                <div class="text-sm text-slate-600 font-medium mb-2">Transaction Flow</div>
                                <div id="previewExplanation" class="text-slate-800"></div>
                            </div>
                            
                            <div id="contraAccountOptions" class="hidden">
                                <div class="text-sm text-slate-600 font-medium mb-2">Alternative accounts available:</div>
                                <div id="contraAccountList" class="space-y-1"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex justify-between items-center mt-8 bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
            <a href="@Url.Action("Index", "Transaction", new { area = "Accountant" })" 
               class="px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Cancel
            </a>
            
            <div class="flex space-x-4">
                <button type="button" id="previewButton" class="px-6 py-3 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg transition-colors">
                    <i class="fas fa-eye mr-2"></i>Preview Transaction
                </button>
                <button type="submit" 
                        class="px-8 py-3 bg-cascadeBlue hover:bg-cascadeBlue/90 text-white rounded-lg transition-colors font-medium">
                    <i class="fas fa-save mr-2"></i>Save Transaction
                </button>
            </div>
        </div>

        <div asp-validation-summary="All" class="text-red-600 mt-6"></div>
    </form>
</div>

@section Scripts {
    <script>
        // Global variables
        let allAccounts = [];
        let selectedAccount = null;
        let currentMapping = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAccounts();
            setupAccountSearch();
            setupDirectionSelection();
            setupFormEvents();
            
            // Set initial values for corrections
            @if (Model.SelectedAccountId > 0)
            {
                @:document.getElementById('selectedAccountId').value = @Model.SelectedAccountId;
                @:loadAccountById(@Model.SelectedAccountId);
            }
            
            // Clear account selection
            document.getElementById('clearAccount').addEventListener('click', function() {
                selectedAccount = null;
                document.getElementById('selectedAccountId').value = '';
                document.getElementById('selectedAccount').classList.add('hidden');
                document.getElementById('accountSearch').value = '';
                clearPreview();
            });

            // Auto-generate functionality
            document.getElementById('generateDescription').addEventListener('click', generateDescription);
            document.getElementById('generateReference').addEventListener('click', generateReference);
            
            // Preview button
            document.getElementById('previewButton').addEventListener('click', updatePreview);

            // Form validation
            document.getElementById('transactionForm').addEventListener('submit', validateForm);
        });

        // Load all accounts
        function loadAccounts() {
            fetch('@Url.Action("SearchAccounts", "Transaction", new { area = "Accountant" })')
                .then(response => response.json())
                .then(data => {
                    allAccounts = data.accounts || [];
                })
                .catch(error => {
                    console.error('Failed to load accounts:', error);
                    allAccounts = [];
                });
        }

        // Setup account search functionality
        function setupAccountSearch() {
            const searchInput = document.getElementById('accountSearch');
            const dropdown = document.getElementById('accountDropdown');

            searchInput.addEventListener('input', function() {
                const term = this.value.toLowerCase();
                if (term.length < 1) {
                    dropdown.classList.add('hidden');
                    return;
                }

                const filteredAccounts = allAccounts.filter(account => 
                    account.displayText.toLowerCase().includes(term)
                );

                displayAccountResults(filteredAccounts);
            });

            searchInput.addEventListener('focus', function() {
                if (allAccounts.length > 0) {
                    displayAccountResults(allAccounts.slice(0, 10));
                }
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
        }

        // Display account search results
        function displayAccountResults(accounts) {
            const dropdown = document.getElementById('accountDropdown');
            
            if (accounts.length === 0) {
                dropdown.innerHTML = '<div class="p-3 text-slate-500">No accounts found</div>';
            } else {
                const html = accounts.map(account => {
                    const typeColor = getAccountTypeColor(account.type);
                    return `<div class="p-3 border-b border-slate-100 hover:bg-slate-50 cursor-pointer account-option" 
                               data-account-id="${account.id}" 
                               data-account-name="${account.name}"
                               data-account-type="${account.type}">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-medium text-slate-900">${account.name}</div>
                                        <div class="text-sm text-slate-500">${account.type}</div>
                                    </div>
                                    <span class="px-2 py-1 text-xs font-medium rounded ${typeColor}">
                                        ${account.type}
                                    </span>
                                </div>
                            </div>`;
                }).join('');
                dropdown.innerHTML = html;

                // Add click handlers
                dropdown.querySelectorAll('.account-option').forEach(element => {
                    element.addEventListener('click', function() {
                        const accountId = this.dataset.accountId;
                        const account = allAccounts.find(a => a.id == accountId);
                        if (account) {
                            selectAccount(account);
                        }
                    });
                });
            }
            
            dropdown.classList.remove('hidden');
        }

        // Select an account
        function selectAccount(account) {
            selectedAccount = account;
            document.getElementById('selectedAccountId').value = account.id;
            document.getElementById('accountSearch').value = '';
            document.getElementById('accountDropdown').classList.add('hidden');
            
            // Show selected account
            const selectedDiv = document.getElementById('selectedAccount');
            selectedDiv.querySelector('span').textContent = account.displayText;
            selectedDiv.classList.remove('hidden');
            
            // Update preview
            updatePreview();
        }

        // Load account by ID (for corrections)
        function loadAccountById(accountId) {
            const account = allAccounts.find(a => a.id == accountId);
            if (account) {
                selectAccount(account);
            } else {
                // Account not loaded yet, try to fetch it
                setTimeout(() => loadAccountById(accountId), 100);
            }
        }

        // Setup direction selection with visual feedback
        function setupDirectionSelection() {
            const radioInputs = document.querySelectorAll('input[name="Direction"]');
            
            radioInputs.forEach(input => {
                input.addEventListener('change', function() {
                    // Update visual state
                    radioInputs.forEach(radio => {
                        const label = radio.closest('label');
                        const dot = label.querySelector('.radio-dot');
                        
                        if (radio.checked) {
                            label.classList.add('ring-2', 'ring-offset-2');
                            dot.classList.remove('hidden');
                            
                            // Add type-specific ring color
                            if (radio.value === '@TransactionDirection.MoneyOut') {
                                label.classList.add('ring-green-500');
                            } else if (radio.value === '@TransactionDirection.MoneyIn') {
                                label.classList.add('ring-blue-500');
                            } else if (radio.value === '@TransactionDirection.Transfer') {
                                label.classList.add('ring-purple-500');
                            }
                        } else {
                            label.classList.remove('ring-2', 'ring-offset-2', 'ring-green-500', 'ring-blue-500', 'ring-purple-500');
                            dot.classList.add('hidden');
                        }
                    });
                    
                    // Update preview
                    updatePreview();
                });
            });
        }

        // Setup form events
        function setupFormEvents() {
            // Update preview when amount changes
            document.getElementById('Amount').addEventListener('input', updatePreview);
            
            // Update preview when description changes
            document.getElementById('descriptionInput').addEventListener('input', updatePreview);
        }

        // Update the transaction preview
        function updatePreview() {
            const selectedAccountId = document.getElementById('selectedAccountId').value;
            const direction = document.querySelector('input[name="Direction"]:checked')?.value;
            const amount = parseFloat(document.getElementById('Amount').value) || 0;

            if (!selectedAccountId || !direction || amount <= 0) {
                showEmptyPreview();
                return;
            }

            // Call the API to get transaction mapping
            fetch('@Url.Action("GetTransactionMapping", "Transaction", new { area = "Accountant" })', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({
                    selectedAccountId: parseInt(selectedAccountId),
                    direction: parseInt(direction),
                    amount: amount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentMapping = data;
                    showMappingPreview(data);
                } else {
                    showErrorPreview(data.error);
                }
            })
            .catch(error => {
                console.error('Error getting transaction mapping:', error);
                showErrorPreview('Failed to get transaction mapping');
            });
        }

        // Show empty preview state
        function showEmptyPreview() {
            document.getElementById('previewEmpty').classList.remove('hidden');
            document.getElementById('previewContent').classList.add('hidden');
        }

        // Show mapping preview
        function showMappingPreview(mapping) {
            document.getElementById('previewEmpty').classList.add('hidden');
            document.getElementById('previewContent').classList.remove('hidden');
            
            // Update preview content
            document.getElementById('previewSelectedAccount').textContent = mapping.primaryAccount.name;
            document.getElementById('previewContraAccount').textContent = mapping.contraAccount.name;
            document.getElementById('previewExplanation').textContent = mapping.explanation;
            
            // Update arrow direction
            const arrow = document.getElementById('previewArrow');
            const direction = document.querySelector('input[name="Direction"]:checked')?.value;
            
            if (direction === '@TransactionDirection.MoneyOut') {
                arrow.className = 'fas fa-arrow-down text-red-500 text-xl';
            } else if (direction === '@TransactionDirection.MoneyIn') {
                arrow.className = 'fas fa-arrow-up text-green-500 text-xl';
            } else if (direction === '@TransactionDirection.Transfer') {
                arrow.className = 'fas fa-exchange-alt text-purple-500 text-xl';
            }
            
            // Show alternative accounts if available
            if (mapping.alternativeContraAccounts && mapping.alternativeContraAccounts.length > 1) {
                const optionsDiv = document.getElementById('contraAccountOptions');
                const listDiv = document.getElementById('contraAccountList');
                
                const alternativeHtml = mapping.alternativeContraAccounts
                    .filter(acc => acc.id !== mapping.contraAccount.id)
                    .slice(0, 3)
                    .map(acc => `<div class="text-xs text-slate-600">${acc.name} (${acc.type})</div>`)
                    .join('');
                
                if (alternativeHtml) {
                    listDiv.innerHTML = alternativeHtml;
                    optionsDiv.classList.remove('hidden');
                } else {
                    optionsDiv.classList.add('hidden');
                }
            }
        }

        // Show error preview
        function showErrorPreview(error) {
            document.getElementById('previewEmpty').classList.add('hidden');
            document.getElementById('previewContent').classList.remove('hidden');
            
            document.getElementById('previewSelectedAccount').textContent = 'Error';
            document.getElementById('previewContraAccount').textContent = error;
            document.getElementById('previewExplanation').textContent = 'Please check your selection and try again.';
            document.getElementById('contraAccountOptions').classList.add('hidden');
        }

        // Clear preview
        function clearPreview() {
            showEmptyPreview();
            currentMapping = null;
        }

        // Get account type color for display
        function getAccountTypeColor(type) {
            const colors = {
                'Asset': 'bg-green-100 text-green-800',
                'Liability': 'bg-red-100 text-red-800',
                'Equity': 'bg-blue-100 text-blue-800',
                'Revenue': 'bg-cyan-100 text-cyan-800',
                'Expense': 'bg-yellow-100 text-yellow-800'
            };
            return colors[type] || 'bg-gray-100 text-gray-800';
        }

        // Form validation
        function validateForm(e) {
            if (!selectedAccount) {
                e.preventDefault();
                alert('Please select an account.');
                return false;
            }
            
            const direction = document.querySelector('input[name="Direction"]:checked');
            if (!direction) {
                e.preventDefault();
                alert('Please select a transaction type.');
                return false;
            }
            
            const amount = parseFloat(document.getElementById('Amount').value) || 0;
            if (amount <= 0) {
                e.preventDefault();
                alert('Please enter a valid amount greater than zero.');
                return false;
            }
            
            const description = document.getElementById('descriptionInput').value.trim();
            if (!description) {
                e.preventDefault();
                alert('Please enter a description.');
                return false;
            }

            return true;
        }

        // Generate description (placeholder - implement based on mapping)
        function generateDescription() {
            if (!currentMapping) {
                alert('Please select an account and transaction type first.');
                return;
            }
            
            // Simple description generation
            const direction = document.querySelector('input[name="Direction"]:checked')?.value;
            let description = '';
            
            if (direction === '@TransactionDirection.MoneyOut') {
                description = `Payment to ${currentMapping.primaryAccount.name}`;
            } else if (direction === '@TransactionDirection.MoneyIn') {
                description = `Receipt from ${currentMapping.primaryAccount.name}`;
            } else if (direction === '@TransactionDirection.Transfer') {
                description = `Transfer from ${currentMapping.contraAccount.name} to ${currentMapping.primaryAccount.name}`;
            }
            
            document.getElementById('descriptionInput').value = description;
        }

        // Generate reference (placeholder)
        function generateReference() {
            const today = new Date();
            const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
            const randomNum = Math.floor(Math.random() * 999) + 1;
            const reference = `TXN-${dateStr}-${String(randomNum).padStart(3, '0')}`;
            
            document.getElementById('referenceInput').value = reference;
        }
    </script>
}

<style>
    .radio-dot {
        transition: all 0.2s ease;
    }
    
    label:has(input[type="radio"]) {
        transition: all 0.2s ease;
    }
    
    .account-option {
        transition: background-color 0.2s ease;
    }
    
    .hover\:bg-slate-50:hover {
        background-color: #f8fafc;
    }
</style>